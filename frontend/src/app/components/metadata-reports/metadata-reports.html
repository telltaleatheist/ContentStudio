<!-- Metadata Reports Viewer -->
<div class="reports-container">
  <div class="page-content">

    <!-- File Browser (Left Panel) -->
    <div class="panel file-browser-panel">
      <div class="panel-header">
        <div>
          <h4 class="panel-title">üìù Metadata Reports</h4>
          <p class="panel-subtitle">
            {{ reports().length }} report{{ reports().length !== 1 ? 's' : '' }} found
            @if (hasSelectedReports()) {
              <span class="selected-count"> ‚Ä¢ {{ getSelectedReports().length }} selected</span>
            }
          </p>
        </div>
        <div class="header-actions">
          @if (hasSelectedReports()) {
            <button mat-raised-button color="primary" (click)="exportSelectedAsTxt()" title="Export selected as TXT">
              <mat-icon>download</mat-icon>
              Export
            </button>
          }
          <button mat-icon-button (click)="loadReports()" [disabled]="isLoading()" title="Refresh reports">
            <mat-icon>refresh</mat-icon>
          </button>
        </div>
      </div>

      <div class="panel-content">
        @if (isLoading() && reports().length === 0) {
          <div class="loading-container">
            <mat-spinner diameter="40"></mat-spinner>
            <p>Loading reports...</p>
          </div>
        }

        @if (!isLoading() && reports().length === 0) {
          <div class="empty-state">
            <mat-icon>description</mat-icon>
            <p>No metadata reports found</p>
            <small>Generate metadata to create reports</small>
          </div>
        }

        @if (reports().length > 0) {
          <div class="select-all-container">
            <mat-checkbox
              [checked]="allReportsSelected()"
              [indeterminate]="hasSelectedReports() && !allReportsSelected()"
              (change)="toggleSelectAll()">
              Select All
            </mat-checkbox>
          </div>

          <div class="reports-list">
            @for (report of reports(); track report.path) {
              <div
                (click)="selectReport(report)"
                [class.selected]="selectedReport()?.path === report.path"
                [class.checked]="report.selected"
                class="report-item">
                <mat-checkbox
                  [checked]="report.selected || false"
                  (click)="toggleSelection(report, $event)"
                  (change)="$event.stopPropagation()"
                  class="report-checkbox">
                </mat-checkbox>
                <div class="report-content">
                  <div class="report-title">{{ report.displayTitle || report.name }}</div>
                  <div class="report-meta">
                    <span class="report-date">{{ formatDate(report.date) }}</span>
                    @if (report.promptSet) {
                      <span class="prompt-set-badge">{{ report.promptSet }}</span>
                    }
                  </div>
                </div>
                <button mat-icon-button (click)="deleteReport(report, $event)" color="warn" class="delete-button">
                  <mat-icon>close</mat-icon>
                </button>
              </div>
            }
          </div>
        }
      </div>
    </div>

    <!-- Report Viewer (Right Panel) -->
    <div class="panel report-viewer-panel">
      @if (selectedReport()) {
        <div class="panel-header">
          <h4 class="panel-title">{{ metadata()?._title || selectedReport()!.name }}</h4>
          <div class="panel-actions">
            <button mat-raised-button color="primary" (click)="showInFolder(selectedReport()!)">
              <mat-icon>folder</mat-icon>
              Show in Folder
            </button>
          </div>
        </div>
      }

      <div class="panel-content viewer-content">
        @if (!selectedReport()) {
          <div class="empty-viewer">
            <mat-icon>touch_app</mat-icon>
            <p>Select a report to view</p>
            <small>Click on a report from the list on the left</small>
          </div>
        }

        @if (isLoading() && selectedReport()) {
          <div class="loading-container">
            <mat-spinner diameter="40"></mat-spinner>
            <p>Loading report...</p>
          </div>
        }

        @if (!isLoading() && selectedReport() && metadata()) {
          <div class="metadata-content">
            <!-- Titles Section -->
            @if (metadata()!.titles && metadata()!.titles.length > 0) {
              <div class="metadata-section">
                <div class="section-header">
                  <div class="section-title-row">
                    <mat-icon>title</mat-icon>
                    <h3>Titles</h3>
                    <span class="count-badge">{{ metadata()!.titles.length }}</span>
                  </div>
                </div>
                <div class="list-container">
                  @for (title of metadata()!.titles; track $index; let i = $index) {
                    <div class="list-item"
                         [class.copied]="isCopied('title-' + i)"
                         (click)="copyToClipboard(getTitleText(title), 'title-' + i)"
                         title="Click to copy">
                      <span class="item-number">{{ i + 1 }}</span>
                      <span class="list-item-text">{{ getTitleText(title) }}</span>
                      <span class="copy-hint">{{ isCopied('title-' + i) ? '‚úì Copied!' : 'üìã' }}</span>
                    </div>
                  }
                </div>
              </div>
            }

            <!-- Description Section -->
            <div class="metadata-section">
              <div class="section-header">
                <div class="section-title-row">
                  <mat-icon>description</mat-icon>
                  <h3>Description</h3>
                </div>
                <span class="char-count">{{ getDescriptionWithHashtags().length }} chars</span>
                <button class="copy-btn"
                        [class.copied]="isCopied('description')"
                        (click)="copyToClipboard(getDescriptionWithHashtags(), 'description')">
                  {{ isCopied('description') ? '‚úì Copied!' : 'Copy' }}
                </button>
              </div>
              <div class="description-box">
                <div class="description-card">
                  <textarea class="description-textarea" readonly [value]="getDescriptionWithHashtags()"></textarea>
                </div>
              </div>
            </div>

            <!-- Tags Section -->
            <div class="metadata-section">
              <div class="section-header">
                <div class="section-title-row">
                  <mat-icon>local_offer</mat-icon>
                  <h3>Tags</h3>
                  <span class="count-badge">{{ getTagsArray().length }}</span>
                </div>
                <button class="copy-btn"
                        [class.copied]="isCopied('tags-all')"
                        (click)="copyToClipboard(getTagsString(), 'tags-all')">
                  {{ isCopied('tags-all') ? '‚úì Copied!' : 'Copy All' }}
                </button>
              </div>
              <div class="tags-container">
                @for (tag of getTagsArray(); track $index; let i = $index) {
                  <mat-chip class="tag-chip"
                            [class.copied]="isCopied('tag-' + i)"
                            (click)="copyToClipboard(tag, 'tag-' + i)">
                    {{ isCopied('tag-' + i) ? '‚úì Copied!' : tag }}
                  </mat-chip>
                }
              </div>
            </div>

            <!-- Thumbnail Text Section -->
            @if (metadata()!.thumbnail_text && metadata()!.thumbnail_text.length > 0) {
              <div class="metadata-section">
                <div class="section-header">
                  <div class="section-title-row">
                    <mat-icon>image</mat-icon>
                    <h3>Thumbnail Text</h3>
                    <span class="count-badge">{{ metadata()!.thumbnail_text.length }}</span>
                  </div>
                </div>
                <div class="thumbnail-list">
                  @for (text of metadata()!.thumbnail_text; track $index; let i = $index) {
                    <div class="thumbnail-item"
                         [class.copied]="isCopied('thumb-' + i)"
                         (click)="copyToClipboard(getThumbnailText(text), 'thumb-' + i)"
                         title="Click to copy">
                      <span class="thumbnail-text">{{ getThumbnailText(text) }}</span>
                      <span class="copy-hint">{{ isCopied('thumb-' + i) ? '‚úì Copied!' : 'üìã' }}</span>
                    </div>
                  }
                </div>
              </div>
            }

            <!-- Chapters Section (if present) -->
            @if (metadata()!.chapters && metadata()!.chapters.length > 0) {
              <div class="metadata-section">
                <div class="section-header">
                  <div class="section-title-row">
                    <mat-icon>list</mat-icon>
                    <h3>Chapters</h3>
                    <span class="count-badge">{{ metadata()!.chapters.length }}</span>
                  </div>
                  <button class="copy-btn"
                          [class.copied]="isCopied('chapters-all')"
                          (click)="copyChaptersToClipboard()">
                    {{ isCopied('chapters-all') ? '‚úì Copied!' : 'Copy All' }}
                  </button>
                </div>
                <div class="chapters-list">
                  @for (chapter of metadata()!.chapters; track $index; let i = $index) {
                    <div class="chapter-item"
                         [class.copied]="isCopied('chapter-' + i)"
                         (click)="copyToClipboard(getChapterTimestamp(chapter) + ' ' + getChapterTitle(chapter), 'chapter-' + i)"
                         title="Click to copy">
                      <span class="chapter-time">{{ getChapterTimestamp(chapter) }}</span>
                      <span class="chapter-title">{{ getChapterTitle(chapter) }}</span>
                      <span class="copy-hint">{{ isCopied('chapter-' + i) ? '‚úì Copied!' : 'üìã' }}</span>
                    </div>
                  }
                </div>
              </div>
            }

            <!-- Pinned Comment Section (if present) -->
            @if (metadata()!.pinned_comment && metadata()!.pinned_comment.length > 0) {
              <div class="metadata-section">
                <div class="section-header">
                  <div class="section-title-row">
                    <mat-icon>push_pin</mat-icon>
                    <h3>Pinned Comment</h3>
                    <span class="count-badge">{{ metadata()!.pinned_comment.length }}</span>
                  </div>
                </div>
                <div class="list-container">
                  @for (comment of metadata()!.pinned_comment; track $index; let i = $index) {
                    <div class="list-item"
                         [class.copied]="isCopied('comment-' + i)"
                         (click)="copyToClipboard(comment, 'comment-' + i)"
                         title="Click to copy">
                      <span class="item-number">{{ i + 1 }}</span>
                      <span class="list-item-text">{{ comment }}</span>
                      <span class="copy-hint">{{ isCopied('comment-' + i) ? '‚úì Copied!' : 'üìã' }}</span>
                    </div>
                  }
                </div>
              </div>
            }
          </div>
        }

        @if (!isLoading() && selectedReport() && !metadata()) {
          <div class="empty-report">
            <mat-icon>info</mat-icon>
            <p>Failed to load metadata</p>
            <small>The metadata file may be missing or malformed</small>
          </div>
        }
      </div>
    </div>

  </div>
</div>
